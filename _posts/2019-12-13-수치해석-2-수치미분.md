---

layout: post
title: "[수치 해석] 수치미분"
subtitle: 
categories: mathematics
tags: numericalanalysis
comments: true

---

​	함수나 데이터의 기울기 혹은 변화도를 알고 싶을 때 <u>미분</u>(Differenciation)을 사용합니다.  정규과정을 이수했다면 고등학교 수학시간 때 미분의 정의와 규칙에 대해 배운적이 있을텐데요, 미분의 정의, 대표 함수들의 미분 및 연쇄 법칙에 관한 것들을 아실껍니다. 
그러나 컴퓨터에서 미분을 하기 위해서는 조금 다른 방법이 필요합니다. 크게 두 가지 방식으로 나눌 수 있습니다. 마치 우리가 함수들에 대해서 미분하는 법을 배우고 익혔듯이 컴퓨터에게도 미분하는 방법을 알려주거나(부호적 방법=심볼릭), 약간의 오차를 허용하고 근사적으로 아는 방법(수치 미분)이 있습니다.   

* 함수를 정확히 알고 있을 때  (예: $$f(x)=\sin(x)$$)
  * 부호 미분 (심볼릭 미분, Symbolic differentiation)  
  * 수치 미분  (Numerical differentiation)
  * 최적화 (Optimization)
* 몇 개의 함수 값만을 알고 있을 때   (예: $$f(x_1), f(x_2), \cdots, f(x_N)$$)
  * 수치 미분  


​	예를 들면 아래와 같이 왼쪽 함수 $$f(x)=\sin(x)$$와  몇 개의 함수값이 있다고 해봅시다. 왼쪽과 같이 함수를 정확하게 알고 있는 경우, 심볼릭 미분이나 최적화 방법을 통해서 빨간 점에서의 기울기를 정확하게 구할 수 있습니다. 하지만 오른쪽과 같이 데이터가 이산적으로 주어져 있는 경우, 빨간 점에서의 기울기를 알아낼 수 있는 방법이 다소 직관적이지 않으며, <u>어떤 값을 미분 값으로 정할 것인가</u>가 수치 미분에서 주로 다루는 내용입니다!

![numAna-2-1](/assets/img/2019-12-13-numericalAnalysis-2-1.png)

이번 포스트에서는 이산 데이터에서 미분 값을 정하는 방법들에 대해서 알아봅시다. 참고로 원래 미분의 정의와 달리 극소 구간 $\Delta x \rightarrow 0$ 대신 유한한 크기의 구간 $\Delta x$를 이용한다고 해서 유한 차분(Finite Difference)라고 부릅니다.



## 유한 차분 (Finite Difference)

아래 소개할 내용들은 유한차분(finite difference)의 방법들이며, 함수값의 차를 이용해서 미분값을 근사합니다. 

| 방법                                 | 그림 예시                                                    | 유한 차분 수식                                               | 정확도            |
| ------------------------------------ | ------------------------------------------------------------ | ------------------------------------------------------------ | ----------------- |
| 전진차분 <br />(Forward Difference)  | ![numAna-2-2](/assets/img/2019-12-13-numericalAnalysis-2-2.png) | $$f'\approx\frac{f_{j+1}-f_j}{\Delta x_j}$$                 | $$O(\Delta x)$$   |
| 후진차분 <br />(Backward Difference) | ![numAna-2-3](/assets/img/2019-12-13-numericalAnalysis-2-3.png) | $$f'\approx\frac{f_{j}-f_{j-1}}{\Delta x_{j-1}}$$           | $$O(\Delta x)$$   |
| 중앙차분 <br />(Central Difference)  | ![numAna-2-4](/assets/img/2019-12-13-numericalAnalysis-2-4.png) | $$f'\approx\frac{f_{j+1}-f_{j-1}}{\Delta x_j+\Delta x_{j-1}}$$ | $$O(\Delta x^2)$$ |

**Note:** 용어를 '전진차분', '후진차분'과 같이 쓸 줄 몰랐는데, 한글용어를 찾아서 사용하니 다소 어색하네요... 

유한 차분 수식에서, $$\Delta x_j=x_{j+1}-x_j$$을 의미하며 만약 균일 간격(uniform grid)으로 이루어진 경우, $$\Delta x_j=\Delta x$$로 통일해서 사용하시면 됩니다. 이 경우 중앙차분의 분모 값은 $$2\Delta x$$이 되겠네요.

**정확도(accuracy)**는 해당 방법의 오차가 간격 $$\Delta x$$에 얼만큼 영향을 받는지를 나타낸 겁니다.  이는 데이터 간격 $$\Delta x$$을 줄일 때, 얼마나 빨리 에러가 감소하는가를 의미하며 차수가 클수록 에러가 빨리 감소합니다. (즉, $$\Delta x$$를 줄여서 얻는 이득이 더 크다!) 따라서 차수가 더 큰 중앙차분이 나머지 둘 보다 좋습니다. 

그러나 이는 데이터를 더 많이 요구 한다는 것을 알아두세요! 전진차분과 후진차분에서는 $$f_{j+1}$$과 $$f_{j-1}$$를 각각 하나씩만 추가적으로 사용하였지만 중앙차분에서는 이 둘 모두를 사용합니다. 미분 값을 계산하는데 함수값을 많이 사용할수록 일반적으로 정확도가 올라갑니다. (이는 아래 내용에서 확인할 수 있습니다.)

**만약 임의의 함수값 $$f_1,\cdots,f_n$$ 에 대해서 미분값 $$f'_j$$을 찾으려면 어떻게 해야 할까요?**



## 테일러 테이블 (Taylor Table)

테일러(Taylor)라는 수학자의 이름이 붙어있는 테일러 시리즈(Taylor series)를 이용해서 표(table)을 만들어서 해결하는 방법이기 때문에 **테일러 표(Taylor Table)**이라고 불리웁니다. 이 방법은 임의의 함수 값들을 알고 있을 때 $$f'j$$값을 구하는 방법을 제시합니다. 예를 들면, 함수값 $$f_{1}, f_{2}, f_{3}$$을 알고 있을 때 미분값 $$f'_{1}$$은 어떻게 구할 수 있을까요?  아래를 보시죠!

참고로 이 예시에서는 균일 간격(uniform grid)를 사용합니다. (즉 $$\Delta x$$로 통일) 비균일 간격(non-uniform grid)의 경우 예시를 아래 숨겨두었으니, 관심있으면 클릭해서 보세요!

테일러 테이블은 각각의 주어진 함수값들을 $$f_j$$에서 전개한 다음 미분값 $$f'_j$$만을 남기고 나머지 항들이 없어지도록 계수를 정하는 방법입니다. 예를 들어, $$f_{j+1}, f_{j},f_{j-1}$$의 함수값이 있다고 해봅시다. 이 함수값들을 이용해서 미분값 $$f'_j$$를 표현하려면 각각의 함수값에 어떤 계수를 곱해서 더해야하는지 알아봅시다. 

즉, $$f'_j = a_1 f_{j+1} + a_2 f_{j} + a_3 f_{j-1}$$라고 생각할 때, 계수 $$a_1, a_2, a_3$$가 어떤 값이어야 **제일 적은 오차를 가지고 $$f'_j$$를 표현할 수 있는지** 알아내는 것입니다. 

<details>
<summary><b>균일간격 테일러테이블 예시1 (클릭!)</b></summary>
<div markdown="1">
아래 표에서 각 열(위쪽)들은 해당 성분이 얼마나 있는지 나타내기 위해서 표시한 것이며, 각 행(왼쪽)들은 미분값과 함수값을 나타낸 것입니다.



|                 | $$f_j$$ | $$f^{(1)}_j$$      | $$f^{(2)}_j$$                     | $$f^{(3)}_j$$                     | $$f^{(4)}_j$$                     |
| --------------- | ------- | ------------------ | --------------------------------- | --------------------------------- | --------------------------------- |
| $$f'_j$$        | 0       | 1                  | 0                                 | 0                                 | 0                                 |
| $$a_1 f_{j+1}$$ | $$a_1$$ | $$a_1\Delta x$$    | $$a_1\frac{1}{2!}\Delta x^2$$    | $$a_1\frac{1}{3!}\Delta x^3$$    | $$a_1\frac{1}{4!}\Delta x^4$$    |
| $$a_2f_{j}$$    | $$a_2$$ | 0                  | 0                                 | 0                                 | 0                                 |
| $$a_3f_{j-1}$$  | $$a_3$$ | $$a_3(-\Delta x)$$ | $$a_3\frac{1}{2!}(-\Delta x)^2$$ | $$a_3\frac{1}{3!}(-\Delta x)^3$$ | $$a_3\frac{1}{4!}(-\Delta x)^4$$ |

이렇게 전개해보면, 미지수 $$a_1, a_2, a_3$$를 가지고 있으므로, 앞의 세 열에 대한 관계식을 세울 수 있습니다. 즉,

(1)$$a_1+a_2+a_3=0$$, (2)$$(a_1-a_3)\Delta x + 1 = 0$$, (3)$$(a_1+a_3)\Delta x^2/2=0 \end{cases}$$ 

의 세 가지 수식을 세울 수 있으며 이 연립방정식을 풀면, $$a_1=-\frac{1}{2\Delta x}, a_2=0, a_3=\frac{1}{2\Delta x}$$이 나옵니다.

따라서 $$f'_j\approx\frac{f_{j+1} - f_{j-1}}{2\Delta x}$$ 로 구할 수 있습니다. 이는 **중앙 차분 (Central Difference)**의 식과 일치합니다.

</div>
</details>



<details>
<summary><b>균일간격 테일러테이블 예시2 (클릭!)</b></summary>
<div markdown="1">

또 다른 예로 $$f_{j+1}, f_{j+2},f_{j+3}$$의 함수값이 있다고 해봅시다.

|                 | $$f_j$$ | $$f^{(1)}_j$$      | $$f^{(2)}_j$$                     | $$f^{(3)}_j$$                     | $$f^{(4)}_j$$                     |
| --------------- | ------- | ------------------ | --------------------------------- | --------------------------------- | --------------------------------- |
| $$f'_j$$        | 0       | 1                  | 0                                 | 0                                 | 0                                 |
| $$a_1 f_{j+1}$$ | $$a_1$$ | $$a_1\Delta x$$    | $$a_1\frac{1}{2!}\Delta x^2$$    | $$a_1\frac{1}{3!}\Delta x^3$$    | $$a_1\frac{1}{4!}\Delta x^4$$    |
| $$a_2 f_{j+2}$$ | $$a_2$$ | $$a_2(2\Delta x)$$ | $$a_2\frac{1}{2!}(2\Delta x)^2$$ | $$a_2\frac{1}{3!}(2\Delta x)^3$$ | $$a_2\frac{1}{4!}(2\Delta x)^4$$ |
| $$a_3f_{j+3}$$  | $$a_3$$ | $$a_3(3\Delta x)$$ | $$a_3\frac{1}{2!}(3\Delta x)^2$$ | $$a_3\frac{1}{3!}(3\Delta x)^3$$ | $$a_3\frac{1}{4!}(3\Delta x)^4$$ |

이렇게 전개해보면, 미지수 $$a_1, a_2, a_3$$를 가지고 있으므로, 앞의 세 열에 대한 관계식을 세울 수 있습니다. 즉,

$$ \begin{cases} a_1+a_2+a_3=0 \\ (a_1 + 2a_2 + 3a_3)\Delta x + 1 = 0 \\ (a_1+4a_2+9a_3)\Delta x^2/2=0 \end{cases} $$ 

의 세 가지 수식을 세울 수 있으며 이 연립방정식을 풀면, $$a_1=\frac{5}{2\Delta x}, a_2=-\frac{8}{2\Delta x}, a_3=\frac{3}{2\Delta x}$$이 나옵니다.

결론: $$f'_j\approx\frac{-5f_{j+1} + 8f_{j+2} - 3 f_{j+3}}{2\Delta x}$$ 로 구할 수 있습니다.
</div>
</details>

</br>

<details>
    <summary><b>비균일 간격(non-uniform grid)일 때 테일러 표 (클릭!)</b>    </summary>
<div markdown="1">

비균일 상황에서는 공통된 차이 $$\Delta x$$를 사용할 수 없으므로 각 구간을 모두 고려해서 처리해야 합니다.  $$\Delta x_j=x_{j+1}-x_j$$라고 둔다면, 테일러 급수는
$$
\begin{align}
f_{j+1} &= f_j +\Delta x_jf^{(1)}_j +\frac{1}{2!}\Delta x_j^2f^{(2)}_j +\frac{1}{3!}\Delta x_j^3f^{(3)}_j + \cdots \\
f_{j+2} &= f_j +(\Delta x_j+\Delta x_{j+1})f^{(1)}_j +\frac{1}{2!}(\Delta x_j+\Delta x_{j+1})^2f^{(2)}_j +\frac{1}{3!}(\Delta x_j+\Delta x_{j+1})^3f^{(3)}_j + \cdots \\
f_{j-1} &= f_j -\Delta x_{j-1}f^{(1)}_j +\frac{1}{2!}\Delta x_{j-1}^2f^{(2)}_j -\frac{1}{3!}\Delta x_{j-1}^3f^{(3)}_j + \cdots \\
\end{align}
$$
와 같이 전개되니 이를 테일러 테이블에서 같은 방식으로 이용하기만 하면 됩니다!

균일 간격에서의 예시2의 경우에 적용하면 아래와 같은 표를 만들 수 있습니다.

|                 | $$f_j$$ | $$f^{(1)}_j$$                                     | $$f^{(2)}_j$$                                                | $$f^{(3)}_j$$                                                | $$f^{(4)}_j$$                                                |
| --------------- | ------- | ------------------------------------------------- | ------------------------------------------------------------ | ------------------------------------------------------------ | ------------------------------------------------------------ |
| $$f'_j$$        | 0       | 1                                                 | 0                                                            | 0                                                            | 0                                                            |
| $$a_1 f_{j+1}$$ | $$a_1$$ | $$a_1\Delta x_j$$                                 | $$a_1\frac{1}{2!}\Delta x_j^2$$                              | $$a_1\frac{1}{3!}\Delta x_j^3$$                              | $$a_1\frac{1}{4!}\Delta x_j^4$$                              |
| $$a_2 f_{j+2}$$ | $$a_2$$ | $$a_2(\Delta x_j+\Delta x_{j+1})$$                | $$a_2\frac{1}{2!}(\Delta x_j+\Delta x_{j+1})^2$$             | $$a_2\frac{1}{3!}(\Delta x_j+\Delta x_{j+1})^3$$             | $$a_2\frac{1}{4!}(\Delta x_j+\Delta x_{j+1})^4$$             |
| $$a_3f_{j+3}$$  | $$a_3$$ | $$a_3(\Delta x_j+\Delta x_{j+1}+\Delta x_{j+2})$$ | $$a_3\frac{1}{2!}(\Delta x_j+\Delta x_{j+1}+\Delta x_{j+2})^2$$ | $$a_3\frac{1}{3!}(\Delta x_j+\Delta x_{j+1}+\Delta x_{j+2})^3$$ | $$a_3\frac{1}{4!}(\Delta x_j+\Delta x_{j+1}+\Delta x_{j+2})^4$$ |

마찬가지로 미지수 3개에 대한 방정식을 세우면 아래와 같은 식을 얻을 수 있습니다. 
$$
\begin{cases} 
a_1 + a_2 + a_3=0 \\ 
a_1\Delta x_{j} + a_2(\Delta x_{j}+\Delta x_{j+1}) + a_3(\Delta x_{j}+\Delta x_{j+1}+\Delta x_{j+2}) + 1 = 0 \\ 
a_1\Delta x_{j}^2 + a_2(\Delta x_{j}+\Delta x_{j+1})^2 + a_3(\Delta x_{j}+\Delta x_{j+1}+\Delta x_{j+2})^2=0 \\
\end{cases}
$$
이 세 식에서 $$\Delta x_{j}+\Delta x_{j+1}+\Delta x_{j+2}$$들은 모두 아는 값이라서 쉽게(?) $$a_1, a_2, a_3$$를 모두 구할 수 있습니다. (손으로 일일히 풀기 귀찮기 때문에 매트랩의 심볼릭을 사용했습니다...) $$x=\Delta x_{j}, y=\Delta x_{j+1}, z=\Delta x_{j+2}$$ 이라고 하면,
$$
a_1 = \frac{(y + z)}{(x - y)(x - z)},\qquad a_2 = \frac{-(x + z)}{(x - y)(y - z)},\qquad a_3 = \frac{(x + y)}{(x - z)(y - z)} \\
$$
와 같은 결과가 나오고, 정리하면
$$
a_1 = \frac{(\Delta x_{j+1} + \Delta x_{j+2})}{(\Delta x_{j} - \Delta x_{j+1})(\Delta x_{j} - \Delta x_{j+2})} \\
a_2 = \frac{-(\Delta x_{j} + \Delta x_{j+2})}{(\Delta x_{j} - \Delta x_{j+1})(\Delta x_{j+1} - \Delta x_{j+2})} \\
a_3 = \frac{(\Delta x_{j} + \Delta x_{j+1})}{(\Delta x_{j} - \Delta x_{j+2})(\Delta x_{j+1} - \Delta x_{j+2})}
$$
로 구해진 계수를 사용하면 됩니다! 이는 균일(uniform) 간격의 경우와 비교하여 계수를 구하는 방식이 조금 복잡해졌을 뿐이지 본질적으로는 같다고 볼 수 있겠죠?

 </div>

</details>



사실 테일러 테이블은 그냥 수식을 전개해서 낮은 차수 항들의 계수를 단순히 0으로 잡아주는거 이상의 의미는 없습니다만, 풀기 쉽게 만들어 놓은 것 뿐입니다. (즉, $$f'_j - a_1 f_{j+1} - a_2 f_{j} - a_3 f_{j-1} = 0$$이라는 관점에서 보면)
$$
\begin{aligned}
f'_j - a_1 f_{j+1} &- a_2 f_{j} - a_3 f_{j-1} \\
& = (-a_1 - a_2 - a_3)f_j + (-a_1\Delta x + a_3\Delta x)f^{(1)}_{j} +  (-a_1\frac{1}{2!}\Delta x^2 - a_3\frac{1}{2!}\Delta x^2)f^{(2)}_j + \cdots 
\end{aligned}
$$
으로 수식 전개를 했을 때, <u>미지수 개수만큼</u>(3개) 앞에서부터 계수들을 0으로 만드는 것입니다. 그렇게 하면 남은 항들($$f^{(3)}_j, f^{(4)}_j, \cdots$$)은 높은 차수의 항들이고 이 값들이 에러로 취급되어 에러 차수가 결정됩니다! ($$\Theta(\Delta x^3)$$, 3차) 미지수 개수가 에러 차수에 직접적으로 연관되어 있다는 점에서, 



## 파데 근사 (Padé Approximation)

자, 테일러 테이블에서는 여러 함수값 $$( \cdots, f_{j-1}, f_j, f_{j+1}, \cdots)$$들을 이용해서 1차 미분값 $$f'_j$$을 구하는 방법이었습니다. 그렇다면, 함수값을 포함해서 1차, 2차, ..., n차 미분값을 이용하는 방법도 있지 않을까요? 그런 관점에서 연구되고 제시된 방법이 **파데 근사(Padé Approximation)**입니다. 

이 방법도 마찬가지로 테일러 급수와 테일러 테이블에서 보았던 방법들을 이용합니다. 이 방법에서 예를 들면 $$f_{j-2}, f_j, f_{j+1}, f'_{j-2}, f'_{j-1}, f''_{j+2}$$의 정보가 있을 때 $$f'_j$$의 근사를 구합니다.

아이디어는 모두 테일러 테이블에 있으니 직접 해봅시다!



## 참고

* 매스매티카(Mathematica)나 매트랩(MATLAB), 울프람알파(WolframAlpha) 등의 상용 프로그램에서 심볼릭 미분을 지원하나, 해당 프로그램들은 비싸기 때문에 학교 외에서는 사용하기  곤란한 감이 있습니다. 무료 소프트웨어인 옥타브(octave)에서 심볼릭 연산을 지원하긴 합니다만...  
* 추가적으로 [수치 해석] 포스트에서는 다루지 않겠지만, 잡음(노이즈, noise)이 포함된 데이터의 경우 이를 적절하게 구하기 위해서 사용하는 방법이 완전히 달라집니다. 이는 노이즈로 인한 함수 값의 변화가 결과에 영향을 주기 때문인데, 수치 미분은 고주파 노이즈에 특히 아주 취약한 모습을 보입니다. 노이즈의 영향을 완화시키고자 여러 방법이 연구되고 있지만, 주로 미분을 해야 하는 상황을 피해서 돌아가는 방법을 선호합니다. (즉, 미분을 사용하지 않도록 아예 문제나 식을 바꿉니다.)
* 에러를 평가하는 방법에 대한 설명은 [여기]()를 참고하세요. 관련 지식이 없는 분들은 꼭 읽어보시기 바래요!

