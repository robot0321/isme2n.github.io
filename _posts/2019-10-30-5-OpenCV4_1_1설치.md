---
layout: post
title: OpenCV 4.1.1 설치
subtitle: 고통과 실패의 build 시도
categories: intelligence
tags: deeplearning
comments: true
---
전체 설치 안내: 이미지 딥러닝을 위한 환경 세팅
이전 글1: [우분투 18.04 LTS 설치]
[우분투 18.04 LTS 설치]: http://naver.com

이전 글2: [CUDA 10.1 및 Nvidia Tools 설치]
[CUDA 10.1 및 Nvidia Tools 설치]: http://naver.com

OpenCV 4.1.1의 빌드에 필요한 의존 package 설치, 빌드 옵션 설정, 빌드 및 오류 수정 과정을 설명합니다. 사실 한번에 된다는 생각은 버리시는게 좋고, 일단 기본적으로 많은 설명에서 이야기하는 내용을 따라가되, 본인 환경에 따라 생기는 문제점들이나 다른 옵션들을 맞춰가면서 수정해야합니다. 전체적인 설치 순서는 아래와 같습니다.
1) 순서는 빌드에 필요한 의존 package를 설치, 라이브러리 path 추가
2) `cmake`로 빌드 옵션 지정해서 빌드 테스트 / 안되면 옵션을 수정하거나 1)로 돌아가서 필요한 package 추가 설치
3) `make`로 빌드 / 안되면 2)에서 옵션을 수정하거나, 1)로 돌아가서 필요한 package를 설치하거나, 코드를 직접 수정해야 함.
4) `make install`로 빌드 완료된 라이브러리들 설치하고, path 추가
해당 순서들을 차례로 설명할 것이다.

**아직 완성되지 않은 글을 올리는 이유는 주로 build option과 build 과정에서의 도움이 되었으면 하는 마음입니다. 다른 글을 주로 참고하시고, 이 글은 문제에 부닺쳤을 때 에러를 잡아낼 수 있는 방법이 되길 바랍니다.**

1. Package 설치
일단 먼저 build에 필요한 package들을 설치한다. 이 목록들은 많은 글들에서 소개하고 있으며, `cmake`를 한번하면 사용할 수 있는 패키지들 목록을 보여주기 때문에 `cmake`를 한 번 해보고 확인 후 설치도 가능하다. 일단 일반적으로 설치하는 패키지를 다 설치해보자.

```bash
sudo apt-get install build-essential cmake pkg-config yasm  -y
sudo apt-get install libjpeg-dev libtiff5-dev libpng-dev -y
sudo apt-get install libavcodec-dev libavformat-dev libswscale-dev libxvidcore-dev libx264-dev libxine2-dev -y
sudo apt-get install libv4l-dev v4l-utils -y
sudo apt-get install libgstreamer1.0-dev libgstreamer-plugins-base1.0-dev -y
sudo apt-get install libqt4-dev -y
sudo apt-get install libatlas-base-dev gfortran libeigen3-dev -y
sudo apt-get install python3-dev python3-numpy -y
sudo apt-get install libblas-dev liblapack-dev -y
sudo apt-get install libpng16-16 libtiff5-dev libgst-dev libgstreamer1.0-dev libglib2.0-dev -y
sudo apt-get install opencl-headers  ocl-icd-libopencl1 -y
sudo apt-get install mesa-utils libgl1-mesa-dri libqt4-opengl-dev -y
sudo apt-get install libatlas-base-dev gfortran libeigen3-dev -y
sudo apt-get install libhdf5-dev -y
```
 
$PATH
$LD_LIBRARY_PATH

path도 수정해야한다.
아래 파일도 수정해야 하는데, 어떤 내용을 수정했는지는 추후 업데이트

subl ../modules/python/common.cmake

subl /home/me/opencv/opencv-4.1.1/modules/core/include/opencv2/core/private.cuda.hpp

subl /usr/local/cuda/include/npp.h


2. build option 
빌드 옵션을 잘 넣는게 시간을 줄이는 관건이다. 그걸 하는게 쉽지 않을 뿐이지... 그 외에도 필요한 라이브러리나 기능들을 잘 추가시키는게 중요한데, `cmake`는 그나마 금방 되지만, `make`로 빌드하면 시간이 엄청 오래 걸리기 때문이다.(1~2시간 이상?). 그걸 한 후에 "아 맞다!!!"하고 다시 고쳐서 다시 빌드 하려면 괴롭다. 가급적이면 빌드 옵션을 꼼꼼히 잘 보고 `make`를 한번만 (물론 한번에 끝날 일은 없을 겁니다) 하도록 하자.

```bash
cmake -DCMAKE_BUILD_TYPE=RELEASE \
-DCMAKE_INSTALL_PREFIX=/usr/local \
-DOPENCV_EXTRA_MODULES_PATH=../../opencv_contrib-4.1.1/modules \
-DWITH_OPENCL=OFF \
-DBUILD_SHARED_LIBS=OFF \
-DWITH_OPENCLAMDFFT=OFF \
-DWITH_OPENCLAMDBLAS=OFF \
-DWITH_VA_INTEL=OFF \
-DWITH_TBB=OFF \
-DWITH_IPP=OFF \
-DWITH_1394=OFF \
-DBUILD_WITH_DEBUG_INFO=OFF \
-DBUILD_DOCS=ON \
-DBUILD_opencv_world=OFF \
-DBUILD_opencv_gapi=OFF \
-DBUILD_opencv_apps=OFF \
-DWITH_EIGEN=ON \
-DWITH_CUDA=ON \
-DCUDA_TOOLKIT_ROOT_DIR=/usr/local/cuda \
-DWITH_NVCUVID=OFF \
-DENABLE_FAST_MATH=1 \
-DCUDA_FAST_MATH=1 \
-DWITH_CUFFT=ON \
-DWITH_CUBLAS=1 \
-DINSTALL_TESTS=OFF \
-DINSTALL_C_EXAMPLES=OFF \
-DINSTALL_PYTHON_EXAMPLES=ON \
-DBUILD_EXAMPLES=OFF \
-DBUILD_TESTS=OFF \
-DBUILD_PERF_TESTS=OFF \
-DWITH_QT=ON \
-DWITH_GTK=OFF \
-DWITH_OPENGL=ON \
-DWITH_V4L=ON  \
-DWITH_FFMPEG=ON \
-DWITH_XINE=ON \
-DPYTHON3_EXECUTABLE=/home/me/anaconda3/bin/python3 \
-DPYTHON3_INCLUDE_DIR=/home/me/anaconda3/include/python3.7m \
-DPYTHON3_NUMPY_INCLUDE_DIRS=/home/me/anaconda3/lib/python3.7/site-packages/numpy/core/include \
-DPYTHON3_PACKAGES_PATH=/home/me/anaconda3/lib/python3.7/site-packages \
-DPYTHON3_LIBRARY=/home/me/anaconda3/lib/libpython3.7m.so \
-DBUILD_NEW_PYTHON_SUPPORT=ON \
-DOPENCV_GENERATE_PKGCONFIG=ON \
../
```
이걸 그대로 사용할 필요는 없고 고쳐가면서 적절하게 잘 빌드되는 걸 찾아야한다. 문제가 생기면 Error 메시지를 검색해서 trouble shooting하는 것을 반복해야 한다. 물론 이 글이 그 trouble shooting의 강도를 좀 줄이는 것을 목표로 하고 있지만...
주의해야 할 사항들이 몇가지 있는데,
**0) 많은 글들에서 옵션을 지정할때 -D 옵션이름=ON/OFF로 표기하나 실제로는 -D옵션이른=ON/OFF로 -D뒤의 띄어쓰기를 없애야한다!!**
1) OpenCV랑 Tensorflow-gpu랑 연동되서 사용되기를 원하는 것이니, `WITH_CUDA=ON`을 포기하면 안된다. 비록 그 부분이 빌드 시간이 제일 많이 걸리고 에러도 많이 나긴 하지만 말이다... 문제가 생기면 CUDA나 driver에서 재설치 하거나 문제를 찾아서 해결해보자. (google it!)  
2) cmake 결과표에서 python 실행 파일이 안 잡힐 경우, 위에있는 5개의 -DPYTHON3_... 옵션으로 직접 지정해줘야 한다.  
3) 


3. `make`로 빌드
많은 블로그 글들에서 다음과 같이 안내를 한다. 
```bash
make -j(쓰레드 갯수)
```
근데 문제는 빌드하다보면 원인을 알 수 없는 문제가 발생한다는 것이다. 이는 -j옵션을 없애고 그냥 make하면 발생하지 않는데, 아마도 library의 의존성 문제 때문에 한 번에 여러 개를 빌드하는 옵션이 잘 안되는 것일거라고 추측된다.
- `nproc`으로 thread 갯수를 확인
- 처음 한번만 `make -j(쓰레드갯수)`를 해보고, 안되면 `make`를 사용해서 한다. 왜냐하면 -j 옵션 붙이면 에러 메시지가 이상하게 나와서 정상적인 확인이 불가능할 수도 있다. `make`하다가 오류나면 수정하고 오류나면 수정하고를 계속 반복해야 한다.


4. 빌드 결과 설치 및 path 설정
make로 만들어낸 라이브러리를 설치하고 잘 설치되었는지 확인하자. make에서 오류 없이 잘 완료되면 아래를 실행하서 설치하고 잘 되었는지 확인하자.

```bash
sudo make install
sudo ldconfig
pkg-config --list-all | grep opencv 
```
OpenCV가 잘 설치 되었다면, opencv4에 대한 정보가 표시될 것이다. 이상으로 OpenCV 4.1.1 설치에 대한 간략한 설명을 마친다.
